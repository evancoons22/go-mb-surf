{{ define "forecast" }}
<div>
    <script>
        function displayClicked(date) { 
            const dayData = dataGroupedByDay[date];

            const dataTable = document.getElementById('forecast-table');
            dataTable.innerHTML = '';

            const dateHeader = document.createElement('h3');
            dateHeader.className = 'date-header';
            dateHeader.textContent = date;
            dateHeader.className = 'text-2x1 text-lg font-bold mb-4';

            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            dateHeader.textContent = days[new Date(date).getDay()] + ' ' + dateHeader.textContent;
            dataTable.appendChild(dateHeader);

            // Create a table for each day
            const table = document.createElement('table');
            table.style.width = '100%';
            table.className = 'w-full text-sm text-left';

            // table.setAttribute('border', '1');

            // Create a header for the table
            const header = table.createTHead();
            const headerRow = header.insertRow();
            headerRow.className = 'text-xs uppercase';
            const headers = ['Hour', 'Primary Swell', 'Secondary Swell'];
            headers.forEach(headerText => {
                const headerCell = document.createElement('th');
                headerCell.textContent = headerText;
                headerCell.className = 'py-3 px-6';
                headerRow.appendChild(headerCell);
            });

            // Create the body of the table
            const tbody = document.createElement('tbody');
            table.appendChild(tbody);

            dayData.forEach(dataItem => {
                const row = tbody.insertRow();
                row.className = 'border-b';


                // Hour column
                const hourCell = row.insertCell();
                // split the date item and take the second part
                hourCell.textContent = dataItem.Date.split(' ')[1];
                // hourCell.textContent = dataItem.date;
                hourCell.className = 'py-2 px-6';

                // Primary swell column
                const primaryCell = row.insertCell();
                primaryCell.innerHTML = createSwellHTML(dataItem.PrimaryDegrees, dataItem.PrimaryWaveHeight, dataItem.PrimaryPeriod);
                primaryCell.className = 'py-2 px-6';

                // Secondary swell column
                const secondaryCell = row.insertCell();
                secondaryCell.innerHTML = createSwellHTML(dataItem.SecondaryDegrees, dataItem.SecondaryWaveHeight, dataItem.SecondaryPeriod);
                secondaryCell.className = 'py-2 px-6';

                // Append the table to the container
                dataTable.appendChild(table);
        }
        )}

        function createSwellHTML(direction, height, period) {
            const arrowHTML = `<span class="swell-arrow text-3xl" style="transform: rotate(${direction - 180}deg); margin-right: 50px;">&#8595;</span>`;

            // Swell height and period information
            const swellInfoHTML = `<span>${height}ft at ${period}s</span>`;

            // Combine the arrow with the swell info
            return `<div class="flex flex-center items-center">${arrowHTML} ${swellInfoHTML}</div>`;
        }

        function convertToDate(data, date) {
            hour = parseInt(data[0].Date.split(' ')[1]);
            firstdate = new Date(date.slice(0, 4), date.slice(4, 6) - 1, date.slice(6, 8), hour);
            for (i = 0; i < data.length; i++) {
                // this date needs to be in UTC!!
                    data[i].dateObj = new Date(firstdate);
                data[i].dateObj.setHours(data[i].dateObj.getHours() + i);
            }
            return data;
        }

        function groupDataByDay(data) {
            // order by date first
            data.sort((a, b) => a.dateObj - b.dateObj);
            const groupedData = {};
            data.forEach(item => {
                item.dateObj.setHours(item.dateObj.getHours() - 8); // subtract 8 hours to get to UTC
                const dateKey = item.dateObj.toISOString().split('T')[0]; // YYYY-MM-DD
                if (!groupedData[dateKey]) {
                    groupedData[dateKey] = [];
                }
                groupedData[dateKey].push(item);
            });
            return groupedData;
        }

        function buildSummary(data) { 
            const summary = [];

            Object.entries(data).forEach(([date, item]) => {
                // get the day of the week
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                const dayOfWeek = days[new Date(date).getDay()];

                // get the abbreviated date
                const datefull = new Date(date).toLocaleDateString().split(' ')[0];
                const abbreviatedDate = datefull.slice(0, datefull.length - 5);

                // keep track of total primary swell
                let totalPrimarySwell = 0;
                item.forEach((item) => {
                    totalPrimarySwell += parseFloat(item.PrimaryWaveHeight);
                });
                const primarySwellAverage = totalPrimarySwell / item.length;

                // get the condition
                let condition = 'good';
                if (primarySwellAverage < 0.5) {
                    condition = 'poor';
                } else if (primarySwellAverage < 1.5) {
                    condition = 'fair';
                }

                summary.push({
                    date: date,
                    dateabv: `${dayOfWeek} ${abbreviatedDate}`,
                    condition: condition
                });
            });

            return summary;
        } 


        let dataGroupedByDay = {};
        let forecastsummary = [];

        document.addEventListener('DOMContentLoaded', () => {
            const data = convertToDate({{.forecast}}, {{.date}});
            console.log(data);
            dataGroupedByDay = groupDataByDay(data);
            console.log(dataGroupedByDay);
            forecastsummary = buildSummary(dataGroupedByDay);
            displayClicked(Object.keys(dataGroupedByDay)[0]);


            const forecastContainer = document.getElementById('forecastContainer');

            forecastsummary.forEach(forecast => {
                const card = document.createElement('div');
                card.className = 'forecastcard  bg-white rounded-lg shadow border border-1 p-4 flex flex-col items-center cursor-pointer hover:bg-gray-100'; // TailwindCSS classes for styling

                card.setAttribute('data-date', forecast.date); // Store the date in a data attribute

                const dayOfWeek = document.createElement('div');
                dayOfWeek.className = 'font-medium';
                dayOfWeek.textContent = forecast.dateabv.split(' ')[0]; // Get the day abbreviation

                const dateEl = document.createElement('div');
                dateEl.className = 'text-sm';
                dateEl.textContent = forecast.dateabv.split(' ')[1]; // Get the date abbreviation

                const conditionEl = document.createElement('div');
                conditionEl.textContent = forecast.condition;
                conditionEl.className = `font-bold ${forecast.condition.toLowerCase() === 'good' ? 'text-green-500' : forecast.condition.toLowerCase() === 'fair' ? 'text-orange-500' : 'text-red-500'}`;

                card.appendChild(dayOfWeek);
                card.appendChild(dateEl);
                card.appendChild(conditionEl);

                forecastContainer.appendChild(card);
            });
            
        });

        document.addEventListener('DOMContentLoaded', () => {
            const data = convertToDate({{.forecast}}, {{.date}});
            const dataGroupedByDay = groupDataByDay(data);
            const cards = document.querySelectorAll('.forecastcard');
            cards.forEach(card => {
                card.addEventListener('click', function() {
                    this.classList.toggle('font-bold'); // This toggles the bold class on click
                    this.classList.toggle('bg-gray-100'); // This toggles the border-3 class on click
                    cards.forEach(otherCard => {
                        if (otherCard !== this) {
                            otherCard.classList.remove('font-bold', 'bg-gray-100');
                        }
                    });
                    displayClicked(this.getAttribute('data-date')); // Call the displayClicked function
                });
            });
        });


    </script>

    <h2 class="text-2x1 text-lg font-bold mt-8">16 Day Forecast</h2>
    <div class = "container mx-auto ">
        <div class="flex overflow-x-auto py-4 space-x-4" id="forecastContainer"> </div>
    </div>
    <div id="forecast-table" class="mt-8"></div>

</div>
{{end}}
